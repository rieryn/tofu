<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width">
    </head>
    <body>
        This page is purely for manual testing
        <table class="control">
            <tr>
                <td class="title">Status:</td>
                <td class="title">Messages:</td>
            </tr>
            <tr>
                <td>
                    <span style="font-weight: bold">ID: </span>
                    <input type="text" id="receiver-id" title="Input the ID from receive.html">
                    <button id="connect-button">Connect</button>
                </td>
                <td>
                    <input type="text" id="sendMessageBox" placeholder="Enter a message..." autofocus="true" />
                    <button type="button" id="sendButton">Send</button>
                    <button type="button" id="clearMsgsButton">Clear Msgs (Local)</button>
                </td>
            </tr>
            <tr>
                <td><div id="status" class="status"></div></td>
                <td><div class="message" id="message"></div></td>
            </tr>
            <tr>
                <td>
                    <button type="button" class="control-button" id="resetButton">Reset</button>
                </td>
            </tr>

        </table>
            <video id="localVideo" playsinline autoplay muted></video>

                <button id="startButton">Start</button>


        <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
        <script type="text/javascript">
            (function () {


                var lastPeerId = null;
                var peer = null; // own peer object
                var conn = null;
                var idInput = document.getElementById("receiver-id");
                var status = document.getElementById("status");
                var message = document.getElementById("message");
                var sendMessageBox = document.getElementById("sendMessageBox");
                var sendButton = document.getElementById("sendButton");
                var connectButton = document.getElementById("connect-button");
                const localVideo = document.getElementById('localVideo');
                var localStream;

                function initialize() {

                    peer = new Peer(null, {
                        debug: 2,
                        host: 'localhost',
                        port: 9000,
                        path: 'peerjs/myapp'                        
                    });

                    peer.on('open', function (id) {
                        if (peer.id === null) {
                            console.log('Received null id from peer open');
                            peer.id = lastPeerId;
                        } else {
                            lastPeerId = peer.id;
                        }

                        console.log('ID: ' + peer.id);
                    });
                    peer.on('connection', function (c) {
                        c.on('open', function() {
                            c.send("Sender does not accept incoming connections");
                            setTimeout(function() { c.close(); }, 500);
                        });
                    });
                    peer.on('disconnected', function () {
                        peer.reconnect();
                    });
                    peer.on('close', function() {
                        conn = null;
                    });
                    peer.on('error', function (err) {
                        console.log(err);
                        alert('' + err);
                    });
                };


                function join() {
                    if (conn) {
                        conn.close();
                    }
                    conn = peer.connect(idInput.value, {
                        reliable: true
                    });

                    conn.on('open', function () {
                        status.innerHTML = "Connected to: " + conn.peer;
                        console.log("Connected to: " + conn.peer);
                    });
                    var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                        getUserMedia({video: true, audio: true}, function(stream) {
                          var call = peer.call(conn.peer, stream);
                          console.log(stream)
                          call.on('stream', function(remoteStream) {
                            localVideo.srcObject = remoteStream;
                          });
                        }, function(err) {
                          console.log('Failed to get local stream' ,err);
                        });

                    conn.on('data', function (data) {
                        addMessage(data);
                    });
                    conn.on('close', function () {
                        status.innerHTML = "closed";
                    });
                };
                function addMessage(msg) {
                    message.innerHTML = msg + message.innerHTML;
                };
                
                async function start() {
                      try {
                        const stream = await navigator.mediaDevices.getUserMedia({audio: true, video: true});
                        localVideo.srcObject = stream;
                        localStream = stream;
                      } catch (e) {
                        alert(`getUserMedia() error: ${e.name}`);
                      }
                    }
                startButton.addEventListener('click', start);
                sendButton.addEventListener('click', function () {
                    if (conn && conn.open) {
                        var msg = sendMessageBox.value;
                        sendMessageBox.value = "";
                        conn.send(msg);
                        addMessage( msg);
                    } 
                });
                connectButton.addEventListener('click', join);
                initialize();
            })();
        </script>
    </body>
</html>
